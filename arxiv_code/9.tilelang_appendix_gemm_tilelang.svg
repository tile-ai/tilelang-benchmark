<?xml version="1.0"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg xmlns="http://www.w3.org/2000/svg">
<g font-family="monospace" font-size="14px">
<text x="57" y="14"  fill="#3D7B7B" font-style="italic" text-anchor="end">1</text><text x="76" y="14" xml:space="preserve"><tspan fill="#AA22FF">@tilelang</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">jit</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="33" text-anchor="end"  fill="#3D7B7B" font-style="italic">2</text><text x="76" y="33" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#FF0000" font-weight="bold">def</tspan>&#160;<tspan fill="#0000FF" font-weight="bold">Matmul</tspan>(<tspan fill="#d62728" font-weight="bold">A</tspan>:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,&#160;<tspan fill="#d62728" font-weight="bold">B</tspan>:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,&#160;<tspan fill="#d62728" font-weight="bold">C</tspan>:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="52" text-anchor="end"  fill="#3D7B7B" font-style="italic">3</text><text x="76" y="52" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">with</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Kernel</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="71" text-anchor="end"  fill="#3D7B7B" font-style="italic">4</text><text x="76" y="71" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(N,&#160;block_N),&#160;<tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(M,&#160;block_M),&#160;threads<tspan fill="#666666">=</tspan><tspan fill="#1f77b4" font-weight="bold">128</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="90" text-anchor="end"  fill="#3D7B7B" font-style="italic">5</text><text x="76" y="90" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;)&#160;<tspan fill="#FF0000" font-weight="bold">as</tspan>&#160;(bx,&#160;by):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="109" text-anchor="end"  fill="#3D7B7B" font-style="italic">6</text><text x="76" y="109" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">A_shared</tspan>&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>((block_M,&#160;block_K))<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="128" text-anchor="end"  fill="#3D7B7B" font-style="italic">7</text><text x="76" y="128" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>((block_K,&#160;block_N))<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="147" text-anchor="end"  fill="#3D7B7B" font-style="italic">8</text><text x="76" y="147" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">C_local</tspan>&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M,&#160;block_N),&#160;accum_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="166" text-anchor="end"  fill="#3D7B7B" font-style="italic">9</text><text x="76" y="166" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="185" text-anchor="end"  fill="#3D7B7B" font-style="italic">10</text><text x="76" y="185" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#3D7B7B" font-style="italic">#&#160;Define&#160;Layout&#160;(Optional)</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="204" text-anchor="end"  fill="#3D7B7B" font-style="italic">11</text><text x="76" y="204" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">annotate_layout</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="223" text-anchor="end"  fill="#3D7B7B" font-style="italic">12</text><text x="76" y="223" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="242" text-anchor="end"  fill="#3D7B7B" font-style="italic">13</text><text x="76" y="242" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">A_shared</tspan>:&#160;<tspan fill="#FF0000" font-weight="bold">your_customized_layout</tspan>(<tspan fill="#d62728" font-weight="bold">A_shared</tspan>),<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="261" text-anchor="end"  fill="#3D7B7B" font-style="italic">14</text><text x="76" y="261" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>:&#160;<tspan fill="#FF0000" font-weight="bold">your_customized_layout</tspan>(<tspan fill="#d62728" font-weight="bold">B_shared</tspan>),<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="280" text-anchor="end"  fill="#3D7B7B" font-style="italic">15</text><text x="76" y="280" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="299" text-anchor="end"  fill="#3D7B7B" font-style="italic">16</text><text x="76" y="299" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="318" text-anchor="end"  fill="#3D7B7B" font-style="italic">17</text><text x="76" y="318" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#3D7B7B" font-style="italic">#&#160;Improve&#160;L2&#160;Cache&#160;Locality&#160;(Optional)</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="337" text-anchor="end"  fill="#3D7B7B" font-style="italic">18</text><text x="76" y="337" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">use_swizzle</tspan>(panel_size<tspan fill="#666666">=</tspan><tspan fill="#1f77b4" font-weight="bold">10</tspan>,&#160;order<tspan fill="#666666">=</tspan><tspan fill="#BA2121">&quot;</tspan><tspan fill="#BA2121">row</tspan><tspan fill="#BA2121">&quot;</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="356" text-anchor="end"  fill="#3D7B7B" font-style="italic">19</text><text x="76" y="356" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="375" text-anchor="end"  fill="#3D7B7B" font-style="italic">20</text><text x="76" y="375" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">clear</tspan>(<tspan fill="#d62728" font-weight="bold">C_local</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="394" text-anchor="end"  fill="#3D7B7B" font-style="italic">21</text><text x="76" y="394" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;k&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Pipelined</tspan>(<tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(K,&#160;block_K),&#160;num_stages<tspan fill="#666666">=</tspan><tspan fill="#1f77b4" font-weight="bold">3</tspan>):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="413" text-anchor="end"  fill="#3D7B7B" font-style="italic">22</text><text x="76" y="413" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(<tspan fill="#d62728" font-weight="bold">A</tspan>[by&#160;<tspan fill="#666666">*</tspan>&#160;block_M,&#160;k&#160;<tspan fill="#666666">*</tspan>&#160;block_K],&#160;<tspan fill="#d62728" font-weight="bold">A_shared</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="432" text-anchor="end"  fill="#3D7B7B" font-style="italic">23</text><text x="76" y="432" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(<tspan fill="#d62728" font-weight="bold">B</tspan>[k&#160;<tspan fill="#666666">*</tspan>&#160;block_K,&#160;bx&#160;<tspan fill="#666666">*</tspan>&#160;block_N],&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="451" text-anchor="end"  fill="#3D7B7B" font-style="italic">24</text><text x="76" y="451" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">gemm</tspan>(<tspan fill="#d62728" font-weight="bold">A_shared</tspan>,&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>,&#160;<tspan fill="#d62728" font-weight="bold">C_local</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="470" text-anchor="end"  fill="#3D7B7B" font-style="italic">25</text><text x="76" y="470" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="489" text-anchor="end"  fill="#3D7B7B" font-style="italic">26</text><text x="76" y="489" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(<tspan fill="#d62728" font-weight="bold">C_local</tspan>,&#160;<tspan fill="#d62728" font-weight="bold">C</tspan>[by&#160;<tspan fill="#666666">*</tspan>&#160;block_M,&#160;bx&#160;<tspan fill="#666666">*</tspan>&#160;block_N])<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="508" text-anchor="end"  fill="#3D7B7B" font-style="italic">27</text><text x="76" y="508" xml:space="preserve"><tspan fill="#bbbbbb"></tspan></text></g></svg>
