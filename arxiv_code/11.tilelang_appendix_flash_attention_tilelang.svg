<?xml version="1.0"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg xmlns="http://www.w3.org/2000/svg">
<g font-family="monospace" font-size="14px">
<text x="57" y="14"  fill="#3D7B7B" font-style="italic" text-anchor="end">1</text><text x="76" y="14" xml:space="preserve"><tspan fill="#AA22FF">@tilelang</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">jit</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="33" text-anchor="end"  fill="#3D7B7B" font-style="italic">2</text><text x="76" y="33" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#FF0000" font-weight="bold">def</tspan>&#160;<tspan fill="#0000FF" font-weight="bold">flash_attention</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="52" text-anchor="end"  fill="#3D7B7B" font-style="italic">3</text><text x="76" y="52" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;Q:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="71" text-anchor="end"  fill="#3D7B7B" font-style="italic">4</text><text x="76" y="71" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;K:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="90" text-anchor="end"  fill="#3D7B7B" font-style="italic">5</text><text x="76" y="90" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;V:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="109" text-anchor="end"  fill="#3D7B7B" font-style="italic">6</text><text x="76" y="109" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;Output:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="128" text-anchor="end"  fill="#3D7B7B" font-style="italic">7</text><text x="76" y="128" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="147" text-anchor="end"  fill="#3D7B7B" font-style="italic">8</text><text x="76" y="147" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">with</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Kernel</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="166" text-anchor="end"  fill="#3D7B7B" font-style="italic">9</text><text x="76" y="166" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(seq_len,&#160;block_M),&#160;batch,&#160;heads,&#160;threads<tspan fill="#666666">=</tspan>threads)&#160;<tspan fill="#FF0000" font-weight="bold">as</tspan>&#160;(bx,&#160;by,&#160;bz):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="185" text-anchor="end"  fill="#3D7B7B" font-style="italic">10</text><text x="76" y="185" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Q_shared&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>(Q_shared_shape,&#160;dtypeQKV)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="204" text-anchor="end"  fill="#3D7B7B" font-style="italic">11</text><text x="76" y="204" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Q_local&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>(Q_local_shape,&#160;dtypeQKV)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="223" text-anchor="end"  fill="#3D7B7B" font-style="italic">12</text><text x="76" y="223" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;K_shared&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>(K_shared_shape,&#160;dtypeQKV)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="242" text-anchor="end"  fill="#3D7B7B" font-style="italic">13</text><text x="76" y="242" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;V_shared&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>(V_shared_shape,&#160;dtypeQKV)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="261" text-anchor="end"  fill="#3D7B7B" font-style="italic">14</text><text x="76" y="261" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M,&#160;block_N),&#160;dtypeAccu)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="280" text-anchor="end"  fill="#3D7B7B" font-style="italic">15</text><text x="76" y="280" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK_sum&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M),&#160;dtypeAccu)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="299" text-anchor="end"  fill="#3D7B7B" font-style="italic">16</text><text x="76" y="299" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK_qkvtype&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M,&#160;block_N),&#160;dtypeQKV)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="318" text-anchor="end"  fill="#3D7B7B" font-style="italic">17</text><text x="76" y="318" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_scale&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M),&#160;dtypeAccu)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="337" text-anchor="end"  fill="#3D7B7B" font-style="italic">18</text><text x="76" y="337" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local_rowmax&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M),&#160;dtypeAccu)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="356" text-anchor="end"  fill="#3D7B7B" font-style="italic">19</text><text x="76" y="356" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;prev_rowmax&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M),&#160;dtypeAccu)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="375" text-anchor="end"  fill="#3D7B7B" font-style="italic">20</text><text x="76" y="375" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;global_l&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M),&#160;dtypeAccu)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="394" text-anchor="end"  fill="#3D7B7B" font-style="italic">21</text><text x="76" y="394" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;block_output&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_M,&#160;dim),&#160;dtypeOut)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="413" text-anchor="end"  fill="#3D7B7B" font-style="italic">22</text><text x="76" y="413" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="432" text-anchor="end"  fill="#3D7B7B" font-style="italic">23</text><text x="76" y="432" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(Q[by,&#160;bx&#160;<tspan fill="#666666">*</tspan>&#160;block_M:(bx&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan>&#160;block_M,&#160;bz,&#160;:],&#160;Q_shared)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="451" text-anchor="end"  fill="#3D7B7B" font-style="italic">24</text><text x="76" y="451" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(Q_shared,&#160;Q_local)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="470" text-anchor="end"  fill="#3D7B7B" font-style="italic">25</text><text x="76" y="470" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i,&#160;j&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M,&#160;dim):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="489" text-anchor="end"  fill="#3D7B7B" font-style="italic">26</text><text x="76" y="489" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Q_local[i,&#160;j]&#160;<tspan fill="#666666">*</tspan><tspan fill="#666666">=</tspan>&#160;scale<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="508" text-anchor="end"  fill="#3D7B7B" font-style="italic">27</text><text x="76" y="508" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">fill</tspan>(block_output,&#160;<tspan fill="#1f77b4" font-weight="bold">0</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="527" text-anchor="end"  fill="#3D7B7B" font-style="italic">28</text><text x="76" y="527" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">fill</tspan>(global_l,&#160;<tspan fill="#1f77b4" font-weight="bold">0</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="546" text-anchor="end"  fill="#3D7B7B" font-style="italic">29</text><text x="76" y="546" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">fill</tspan>(local_rowmax,&#160;<tspan fill="#666666">-</tspan><tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>infinity(dtypeAccu))<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="565" text-anchor="end"  fill="#3D7B7B" font-style="italic">30</text><text x="76" y="565" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="584" text-anchor="end"  fill="#3D7B7B" font-style="italic">31</text><text x="76" y="584" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;k&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Pipelined</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="603" text-anchor="end"  fill="#3D7B7B" font-style="italic">32</text><text x="76" y="603" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>((bx&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="622" text-anchor="end"  fill="#3D7B7B" font-style="italic">33</text><text x="76" y="622" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;block_M,&#160;block_N)&#160;<tspan fill="#FF0000" font-weight="bold">if</tspan>&#160;is_causal&#160;<tspan fill="#FF0000" font-weight="bold">else</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(seq_len,&#160;block_N),<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="641" text-anchor="end"  fill="#3D7B7B" font-style="italic">34</text><text x="76" y="641" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;num_stages<tspan fill="#666666">=</tspan>num_stages):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="660" text-anchor="end"  fill="#3D7B7B" font-style="italic">35</text><text x="76" y="660" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(K[by,&#160;k&#160;<tspan fill="#666666">*</tspan>&#160;block_N:(k&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan>&#160;block_N,&#160;bz,&#160;:],&#160;K_shared)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="679" text-anchor="end"  fill="#3D7B7B" font-style="italic">36</text><text x="76" y="679" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(V[by,&#160;k&#160;<tspan fill="#666666">*</tspan>&#160;block_N:(k&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan>&#160;block_N,&#160;bz,&#160;:],&#160;V_shared)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="698" text-anchor="end"  fill="#3D7B7B" font-style="italic">37</text><text x="76" y="698" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">if</tspan>&#160;is_causal:<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="717" text-anchor="end"  fill="#3D7B7B" font-style="italic">38</text><text x="76" y="717" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i,&#160;j&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M,&#160;block_N):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="736" text-anchor="end"  fill="#3D7B7B" font-style="italic">39</text><text x="76" y="736" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK[i,&#160;j]&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>if_then_else(bx&#160;<tspan fill="#666666">*</tspan>&#160;block_M&#160;<tspan fill="#666666">+</tspan>&#160;i&#160;<tspan fill="#666666">&gt;</tspan><tspan fill="#666666">=</tspan>&#160;k&#160;<tspan fill="#666666">*</tspan>&#160;block_N&#160;<tspan fill="#666666">+</tspan>&#160;j,&#160;<tspan fill="#1f77b4" font-weight="bold">0</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="755" text-anchor="end"  fill="#3D7B7B" font-style="italic">40</text><text x="76" y="755" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#666666">-</tspan><tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>infinity(dtypeAccu))<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="774" text-anchor="end"  fill="#3D7B7B" font-style="italic">41</text><text x="76" y="774" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">else</tspan>:<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="793" text-anchor="end"  fill="#3D7B7B" font-style="italic">42</text><text x="76" y="793" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">fill</tspan>(score_QK,&#160;<tspan fill="#1f77b4" font-weight="bold">0</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="812" text-anchor="end"  fill="#3D7B7B" font-style="italic">43</text><text x="76" y="812" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">gemm</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="831" text-anchor="end"  fill="#3D7B7B" font-style="italic">44</text><text x="76" y="831" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Q_local,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="850" text-anchor="end"  fill="#3D7B7B" font-style="italic">45</text><text x="76" y="850" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;K_shared,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="869" text-anchor="end"  fill="#3D7B7B" font-style="italic">46</text><text x="76" y="869" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="888" text-anchor="end"  fill="#3D7B7B" font-style="italic">47</text><text x="76" y="888" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;policy<tspan fill="#666666">=</tspan><tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>GemmWarpPolicy<tspan fill="#666666">.</tspan>FullRow,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="907" text-anchor="end"  fill="#3D7B7B" font-style="italic">48</text><text x="76" y="907" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="926" text-anchor="end"  fill="#3D7B7B" font-style="italic">49</text><text x="76" y="926" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(local_rowmax,&#160;prev_rowmax)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="945" text-anchor="end"  fill="#3D7B7B" font-style="italic">50</text><text x="76" y="945" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>reduce_max(score_QK,&#160;local_rowmax,&#160;dim<tspan fill="#666666">=</tspan><tspan fill="#1f77b4" font-weight="bold">1</tspan>,&#160;<tspan fill="#9467bd" font-weight="bold">clear</tspan><tspan fill="#666666">=</tspan><tspan fill="#FF0000" font-weight="bold">False</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="964" text-anchor="end"  fill="#3D7B7B" font-style="italic">51</text><text x="76" y="964" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i,&#160;j&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M,&#160;block_N):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="983" text-anchor="end"  fill="#3D7B7B" font-style="italic">52</text><text x="76" y="983" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK[i,&#160;j]&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>exp2(score_QK[i,&#160;j]&#160;<tspan fill="#666666">-</tspan>&#160;local_rowmax[i])<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1002" text-anchor="end"  fill="#3D7B7B" font-style="italic">53</text><text x="76" y="1002" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1021" text-anchor="end"  fill="#3D7B7B" font-style="italic">54</text><text x="76" y="1021" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_scale[i]&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>exp2(prev_rowmax[i]&#160;<tspan fill="#666666">-</tspan>&#160;local_rowmax[i])<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1040" text-anchor="end"  fill="#3D7B7B" font-style="italic">55</text><text x="76" y="1040" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i,&#160;j&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M,&#160;dim):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1059" text-anchor="end"  fill="#3D7B7B" font-style="italic">56</text><text x="76" y="1059" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;block_output[i,&#160;j]&#160;<tspan fill="#666666">*</tspan><tspan fill="#666666">=</tspan>&#160;score_scale[i]<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1078" text-anchor="end"  fill="#3D7B7B" font-style="italic">57</text><text x="76" y="1078" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(score_QK,&#160;score_QK_qkvtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1097" text-anchor="end"  fill="#3D7B7B" font-style="italic">58</text><text x="76" y="1097" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">gemm</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1116" text-anchor="end"  fill="#3D7B7B" font-style="italic">59</text><text x="76" y="1116" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;score_QK_qkvtype,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1135" text-anchor="end"  fill="#3D7B7B" font-style="italic">60</text><text x="76" y="1135" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;V_shared,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1154" text-anchor="end"  fill="#3D7B7B" font-style="italic">61</text><text x="76" y="1154" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;block_output,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1173" text-anchor="end"  fill="#3D7B7B" font-style="italic">62</text><text x="76" y="1173" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;policy<tspan fill="#666666">=</tspan><tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>GemmWarpPolicy<tspan fill="#666666">.</tspan>FullRow,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1192" text-anchor="end"  fill="#3D7B7B" font-style="italic">63</text><text x="76" y="1192" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1211" text-anchor="end"  fill="#3D7B7B" font-style="italic">64</text><text x="76" y="1211" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan>reduce_sum(score_QK,&#160;score_QK_sum,&#160;dim<tspan fill="#666666">=</tspan><tspan fill="#1f77b4" font-weight="bold">1</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1230" text-anchor="end"  fill="#3D7B7B" font-style="italic">65</text><text x="76" y="1230" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1249" text-anchor="end"  fill="#3D7B7B" font-style="italic">66</text><text x="76" y="1249" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;global_l[i]&#160;<tspan fill="#666666">=</tspan>&#160;global_l[i]&#160;<tspan fill="#666666">*</tspan>&#160;score_scale[i]&#160;<tspan fill="#666666">+</tspan>&#160;score_QK_sum[i]<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1268" text-anchor="end"  fill="#3D7B7B" font-style="italic">67</text><text x="76" y="1268" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i,&#160;j&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_M,&#160;dim):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1287" text-anchor="end"  fill="#3D7B7B" font-style="italic">68</text><text x="76" y="1287" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;block_output[i,&#160;j]&#160;<tspan fill="#666666">/</tspan><tspan fill="#666666">=</tspan>&#160;global_l[i]<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1306" text-anchor="end"  fill="#3D7B7B" font-style="italic">69</text><text x="76" y="1306" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(block_output,&#160;Output[by,&#160;bx&#160;<tspan fill="#666666">*</tspan>&#160;block_M:(bx&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan>&#160;block_M,&#160;bz,&#160;:])<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="1325" text-anchor="end"  fill="#3D7B7B" font-style="italic">70</text><text x="76" y="1325" xml:space="preserve"><tspan fill="#bbbbbb"></tspan></text></g></svg>
