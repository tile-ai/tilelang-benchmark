<?xml version="1.0"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg xmlns="http://www.w3.org/2000/svg">
<g font-family="monospace" font-size="14px">
<text x="57" y="14"  fill="#3D7B7B" font-style="italic" text-anchor="end">1</text><text x="76" y="14" xml:space="preserve"><tspan fill="#AA22FF">@tilelang</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">jit</tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="33" text-anchor="end"  fill="#3D7B7B" font-style="italic">2</text><text x="76" y="33" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#FF0000" font-weight="bold">def</tspan>&#160;<tspan fill="#0000FF" font-weight="bold">matmul_fp16_fp4</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="52" text-anchor="end"  fill="#3D7B7B" font-style="italic">3</text><text x="76" y="52" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">A</tspan>:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="71" text-anchor="end"  fill="#3D7B7B" font-style="italic">4</text><text x="76" y="71" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">B</tspan>:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="90" text-anchor="end"  fill="#3D7B7B" font-style="italic">5</text><text x="76" y="90" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;Ct:&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Buffer</tspan>,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="109" text-anchor="end"  fill="#3D7B7B" font-style="italic">6</text><text x="76" y="109" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="128" text-anchor="end"  fill="#3D7B7B" font-style="italic">7</text><text x="76" y="128" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">with</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Kernel</tspan>(<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(N,&#160;block_N),&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">ceildiv</tspan>(M,&#160;block_M),&#160;threads<tspan fill="#666666">=</tspan>threads)&#160;<tspan fill="#FF0000" font-weight="bold">as</tspan>&#160;(bx,&#160;by):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="147" text-anchor="end"  fill="#3D7B7B" font-style="italic">8</text><text x="76" y="147" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">A_shared</tspan>&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>(A_shared_shape,&#160;in_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="166" text-anchor="end"  fill="#3D7B7B" font-style="italic">9</text><text x="76" y="166" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>(B_shared_shape,&#160;storage_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="185" text-anchor="end"  fill="#3D7B7B" font-style="italic">10</text><text x="76" y="185" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;B_local&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>(B_shared_shape,&#160;storage_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="204" text-anchor="end"  fill="#3D7B7B" font-style="italic">11</text><text x="76" y="204" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;B_dequantize_local&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>(B_dequantize_shared_shape,&#160;in_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="223" text-anchor="end"  fill="#3D7B7B" font-style="italic">12</text><text x="76" y="223" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;B_dequantize_prev_local&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>(B_dequantize_shared_shape,&#160;in_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="242" text-anchor="end"  fill="#3D7B7B" font-style="italic">13</text><text x="76" y="242" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Ct_local&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_fragment</tspan>((block_N,&#160;block_M),&#160;accum_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="261" text-anchor="end"  fill="#3D7B7B" font-style="italic">14</text><text x="76" y="261" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Ct_shared&#160;<tspan fill="#666666">=</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">alloc_shared</tspan>((block_N,&#160;block_M),&#160;out_dtype)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="280" text-anchor="end"  fill="#3D7B7B" font-style="italic">15</text><text x="76" y="280" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="299" text-anchor="end"  fill="#3D7B7B" font-style="italic">16</text><text x="76" y="299" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">annotate_layout</tspan>(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="318" text-anchor="end"  fill="#3D7B7B" font-style="italic">17</text><text x="76" y="318" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="337" text-anchor="end"  fill="#3D7B7B" font-style="italic">18</text><text x="76" y="337" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>:&#160;tilelang<tspan fill="#666666">.</tspan>layout<tspan fill="#666666">.</tspan>make_swizzled_layout(<tspan fill="#d62728" font-weight="bold">B_shared</tspan>),<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="356" text-anchor="end"  fill="#3D7B7B" font-style="italic">19</text><text x="76" y="356" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Ct_shared:&#160;tilelang<tspan fill="#666666">.</tspan>layout<tspan fill="#666666">.</tspan>make_swizzled_layout(Ct_shared),<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="375" text-anchor="end"  fill="#3D7B7B" font-style="italic">20</text><text x="76" y="375" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="394" text-anchor="end"  fill="#3D7B7B" font-style="italic">21</text><text x="76" y="394" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="413" text-anchor="end"  fill="#3D7B7B" font-style="italic">22</text><text x="76" y="413" xml:space="preserve"><tspan fill="#bbbbbb"></tspan><tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="432" text-anchor="end"  fill="#3D7B7B" font-style="italic">23</text><text x="76" y="432" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">clear</tspan>(Ct_local)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="451" text-anchor="end"  fill="#3D7B7B" font-style="italic">24</text><text x="76" y="451" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;k&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Pipelined</tspan>(K&#160;<tspan fill="#666666">/</tspan><tspan fill="#666666">/</tspan>&#160;block_K,&#160;num_stages<tspan fill="#666666">=</tspan>num_stages):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="470" text-anchor="end"  fill="#3D7B7B" font-style="italic">25</text><text x="76" y="470" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(<tspan fill="#d62728" font-weight="bold">A</tspan>[by&#160;<tspan fill="#666666">*</tspan>&#160;block_M,&#160;k&#160;<tspan fill="#666666">*</tspan>&#160;block_K],&#160;<tspan fill="#d62728" font-weight="bold">A_shared</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="489" text-anchor="end"  fill="#3D7B7B" font-style="italic">26</text><text x="76" y="489" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(<tspan fill="#d62728" font-weight="bold">B</tspan>[bx&#160;<tspan fill="#666666">*</tspan>&#160;block_N,&#160;k&#160;<tspan fill="#666666">*</tspan>&#160;block_K&#160;<tspan fill="#666666">/</tspan><tspan fill="#666666">/</tspan>&#160;num_elems_per_byte],&#160;<tspan fill="#d62728" font-weight="bold">B_shared</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="508" text-anchor="end"  fill="#3D7B7B" font-style="italic">27</text><text x="76" y="508" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(<tspan fill="#d62728" font-weight="bold">B_shared</tspan>,&#160;B_local)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="527" text-anchor="end"  fill="#3D7B7B" font-style="italic">28</text><text x="76" y="527" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#FF0000" font-weight="bold">for</tspan>&#160;i,&#160;j&#160;<tspan fill="#1f77b4" font-weight="bold">in</tspan>&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">Parallel</tspan>(block_N,&#160;block_K):<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="546" text-anchor="end"  fill="#3D7B7B" font-style="italic">29</text><text x="76" y="546" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;B_dequantize_local[i,&#160;j]&#160;<tspan fill="#666666">=</tspan>&#160;_tir_u8_to_f4_to_f16(<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="565" text-anchor="end"  fill="#3D7B7B" font-style="italic">30</text><text x="76" y="565" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;num_bits,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="584" text-anchor="end"  fill="#3D7B7B" font-style="italic">31</text><text x="76" y="584" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;B_local[i,&#160;j&#160;<tspan fill="#666666">/</tspan><tspan fill="#666666">/</tspan>&#160;num_elems_per_byte],<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="603" text-anchor="end"  fill="#3D7B7B" font-style="italic">32</text><text x="76" y="603" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;j&#160;<tspan fill="#666666">%</tspan>&#160;num_elems_per_byte,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="622" text-anchor="end"  fill="#3D7B7B" font-style="italic">33</text><text x="76" y="622" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;dtype<tspan fill="#666666">=</tspan>in_dtype,<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="641" text-anchor="end"  fill="#3D7B7B" font-style="italic">34</text><text x="76" y="641" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="660" text-anchor="end"  fill="#3D7B7B" font-style="italic">35</text><text x="76" y="660" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(B_dequantize_local,&#160;B_dequantize_prev_local)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="679" text-anchor="end"  fill="#3D7B7B" font-style="italic">36</text><text x="76" y="679" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">gemm</tspan>(B_dequantize_prev_local,&#160;<tspan fill="#d62728" font-weight="bold">A_shared</tspan>,&#160;Ct_local,&#160;transpose_B<tspan fill="#666666">=</tspan><tspan fill="#FF0000" font-weight="bold">True</tspan>)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="698" text-anchor="end"  fill="#3D7B7B" font-style="italic">37</text><text x="76" y="698" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(Ct_local,&#160;Ct_shared)<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="717" text-anchor="end"  fill="#3D7B7B" font-style="italic">38</text><text x="76" y="717" xml:space="preserve"><tspan fill="#bbbbbb"></tspan>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<tspan fill="#9467bd" font-weight="bold">T</tspan><tspan fill="#666666">.</tspan><tspan fill="#9467bd" font-weight="bold">copy</tspan>(Ct_shared,&#160;Ct[bx&#160;<tspan fill="#666666">*</tspan>&#160;block_N&#160;:&#160;(bx&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan>&#160;block_N,&#160;by&#160;<tspan fill="#666666">*</tspan>&#160;block_M&#160;:&#160;(by&#160;<tspan fill="#666666">+</tspan>&#160;<tspan fill="#1f77b4" font-weight="bold">1</tspan>)&#160;<tspan fill="#666666">*</tspan>&#160;block_M])<tspan fill="#bbbbbb"></tspan></text>
<text x="57" y="736" text-anchor="end"  fill="#3D7B7B" font-style="italic">39</text><text x="76" y="736" xml:space="preserve"><tspan fill="#bbbbbb"></tspan></text></g></svg>
